<script type="text/javascript"><!--
    // These variables are used by the web2py_ajax_init function in web2py_ajax.js (which is loaded below).
    var w2p_ajax_confirm_message = "{{=T('Are you sure you want to delete this object?')}}";
    var w2p_ajax_disable_with_message = "{{=T('Working...')}}";
    var w2p_ajax_date_format = "{{=T('%Y-%m-%d')}}";
    var w2p_ajax_datetime_format = "{{=T('%Y-%m-%d %H:%M:%S')}}";
    var ajax_error_500 = '{{=XML(T('An error occured, please %s the page') % A(T('reload'), _href=URL(args=request.args, vars=request.get_vars))) }}'
    //--></script>
{{
response.files.insert(0,URL('static','js/jquery.js'))
response.files.insert(1,URL('static','css/calendar.css'))
response.files.insert(2,URL('static','js/calendar.js'))
response.files.insert(4,URL('static','js/web2py.js'))
response.include_meta()
response.include_files()
}}
<script type="text/javascript"><!--
function web2py_trap_form(action,target) {
   jQuery('#'+target+' form').each(function(i){
      var form=jQuery(this);
      if(!form.hasClass('no_trap')){
         if(form.find('.upload').length>0){
            //using ajaxForm has the disadvantage that the header is not returned in xhr
            //can this be fixed in the ajaxForm plugin???
             form.ajaxForm({ 
                url: action,
                success: function(data, statusText, xhr) {
                    complete_web2py_ajax_page(xhr, data, action, target)
                }
             });
         }else{
            form.submit(function(obj){
             jQuery('.flash').hide().html('');
             web2py_ajax_page('post',action,form.serialize(),target);
             return false;
            });
         }
      }
   });
}
function complete_web2py_ajax_page (xhr, text, action, target){
      var html=xhr.responseText;
      var content=xhr.getResponseHeader('web2py-component-content'); 
      var command=xhr.getResponseHeader('web2py-component-command');
      var flash=xhr.getResponseHeader('web2py-component-flash');
      var t = jQuery('#'+target);
      if(content=='prepend') t.prepend(html); 
      else if(content=='append') t.append(html);
      else if(content!='hide') t.html(html);  
      web2py_trap_form(action,target);
      web2py_ajax_init();      
      if(command) eval(command);
      if(flash) jQuery('.flash').html(flash).slideDown();
}
function web2py_ajax_page(method,action,data,target) {
  jQuery.ajax({'type':method,'url':action,'data':data,
    'beforeSend':function(xhr) {
      xhr.setRequestHeader('web2py-component-location',document.location);
      xhr.setRequestHeader('web2py-component-element',target);},
    'complete':function(xhr,text){
        complete_web2py_ajax_page(xhr, text, action, target);
      }
    });
}
function web2py_component(action,target) {
    //jQuery(document).ready(function(){ //this caused some trouble for me
        $('#'+target).prepend('{{=IMG(_alt="loading ...", _src=URL(request.application, 'static/images', 'loading.gif'))}}');// just some eyecandy, you can remove it if you want
        web2py_ajax_page('get',action,null,target); 
      //  });
}
    //--></script>
